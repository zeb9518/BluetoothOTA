if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((n=>t.resolve(e()).then((()=>n))),(n=>t.resolve(e()).then((()=>{throw n}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...n){uni.__log__?uni.__log__(e,t,...n):console[e].apply(console,[...n,t])}const n=t=>(n,r=e.getCurrentInstance())=>{!e.isInSSRComponentSetup&&e.injectHook(t,n,r)},r=n("onShow"),i=n("onReady"),s=n("onUnload");
/*!
   * pinia v2.1.7
   * (c) 2023 Eduardo San Martin Morote
   * @license MIT
   */
let a;const o=e=>a=e,c=Symbol();function l(e){return e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)&&"function"!=typeof e.toJSON}var u,d;(d=u||(u={})).direct="direct",d.patchObject="patch object",d.patchFunction="patch function";const f="undefined"!=typeof window;function h(){const t=e.effectScope(!0),n=t.run((()=>e.ref({})));let r=[],i=[];const s=e.markRaw({install(e){o(s),s._a=e,e.provide(c,s),e.config.globalProperties.$pinia=s,i.forEach((e=>r.push(e))),i=[]},use(e){return this._a?r.push(e):i.push(e),this},_p:r,_a:null,_e:t,_s:new Map,state:n});return s}const p=()=>{};function v(t,n,r,i=p){t.push(n);const s=()=>{const e=t.indexOf(n);e>-1&&(t.splice(e,1),i())};return!r&&e.getCurrentScope()&&e.onScopeDispose(s),s}function g(e,...t){e.slice().forEach((e=>{e(...t)}))}const m=e=>e();function y(t,n){t instanceof Map&&n instanceof Map&&n.forEach(((e,n)=>t.set(n,e))),t instanceof Set&&n instanceof Set&&n.forEach(t.add,t);for(const r in n){if(!n.hasOwnProperty(r))continue;const i=n[r],s=t[r];l(s)&&l(i)&&t.hasOwnProperty(r)&&!e.isRef(i)&&!e.isReactive(i)?t[r]=y(s,i):t[r]=i}return t}const w=Symbol();const{assign:b}=Object;function $(t,n,r={},i,s,a){let c;const d=b({actions:{}},r),f={deep:!0};let h,$,x,D=[],E=[];const S=i.state.value[t];let A;function I(n){let r;h=$=!1,"function"==typeof n?(n(i.state.value[t]),r={type:u.patchFunction,storeId:t,events:x}):(y(i.state.value[t],n),r={type:u.patchObject,payload:n,storeId:t,events:x});const s=A=Symbol();e.nextTick().then((()=>{A===s&&(h=!0)})),$=!0,g(D,r,i.state.value[t])}a||S||(i.state.value[t]={}),e.ref({});const _=a?function(){const{state:e}=r,t=e?e():{};this.$patch((e=>{b(e,t)}))}:p;function V(e,n){return function(){o(i);const r=Array.from(arguments),s=[],a=[];function c(e){s.push(e)}function l(e){a.push(e)}let u;g(E,{args:r,name:e,store:N,after:c,onError:l});try{u=n.apply(this&&this.$id===t?this:N,r)}catch(d){throw g(a,d),d}return u instanceof Promise?u.then((e=>(g(s,e),e))).catch((e=>(g(a,e),Promise.reject(e)))):(g(s,u),u)}}const B={_p:i,$id:t,$onAction:v.bind(null,E),$patch:I,$reset:_,$subscribe(n,r={}){const s=v(D,n,r.detached,(()=>a())),a=c.run((()=>e.watch((()=>i.state.value[t]),(e=>{("sync"===r.flush?$:h)&&n({storeId:t,type:u.direct,events:x},e)}),b({},f,r))));return s},$dispose:function(){c.stop(),D=[],E=[],i._s.delete(t)}},N=e.reactive(B);i._s.set(t,N);const C=(i._a&&i._a.runWithContext||m)((()=>i._e.run((()=>(c=e.effectScope()).run(n)))));for(const o in C){const n=C[o];if(e.isRef(n)&&(O=n,!e.isRef(O)||!O.effect)||e.isReactive(n))a||(!S||l(M=n)&&M.hasOwnProperty(w)||(e.isRef(n)?n.value=S[o]:y(n,S[o])),i.state.value[t][o]=n);else if("function"==typeof n){const e=V(o,n);C[o]=e,d.actions[o]=n}}var M,O;return b(N,C),b(e.toRaw(N),C),Object.defineProperty(N,"$state",{get:()=>i.state.value[t],set:e=>{I((t=>{b(t,e)}))}}),i._p.forEach((e=>{b(N,c.run((()=>e({store:N,app:i._a,pinia:i,options:d}))))})),S&&a&&r.hydrate&&r.hydrate(N.$state,S),h=!0,$=!0,N}function x(t,n,r){let i,s;const l="function"==typeof n;function u(t,r){const u=e.hasInjectionContext();(t=t||(u?e.inject(c,null):null))&&o(t),(t=a)._s.has(i)||(l?$(i,n,s,t):function(t,n,r,i){const{state:s,actions:a,getters:c}=n,l=r.state.value[t];let u;u=$(t,(function(){l||(r.state.value[t]=s?s():{});const n=e.toRefs(r.state.value[t]);return b(n,a,Object.keys(c||{}).reduce(((n,i)=>(n[i]=e.markRaw(e.computed((()=>{o(r);const e=r._s.get(t);return c[i].call(e,e)}))),n)),{}))}),n,r,0,!0)}(i,s,t));return t._s.get(i)}return"string"==typeof t?(i=t,s=l?r:n):(s=t,i=t.id),u.$id=i,u}let D="Store";function E(e,t){return Array.isArray(t)?t.reduce(((t,n)=>(t[n]=function(){return e(this.$pinia)[n]},t)),{}):Object.keys(t).reduce(((n,r)=>(n[r]=function(){const n=e(this.$pinia),i=t[r];return"function"==typeof i?i.call(this,n):n[i]},n)),{})}const S=E;const A=Object.freeze(Object.defineProperty({__proto__:null,get MutationType(){return u},PiniaVuePlugin:function(e){e.mixin({beforeCreate(){const e=this.$options;if(e.pinia){const t=e.pinia;if(!this._provided){const e={};Object.defineProperty(this,"_provided",{get:()=>e,set:t=>Object.assign(e,t)})}this._provided[c]=t,this.$pinia||(this.$pinia=t),t._a=this,f&&o(t)}else!this.$pinia&&e.parent&&e.parent.$pinia&&(this.$pinia=e.parent.$pinia)},destroyed(){delete this._pStores}})},acceptHMRUpdate:function(e,t){return()=>{}},createPinia:h,defineStore:x,getActivePinia:()=>e.hasInjectionContext()&&e.inject(c)||a,mapActions:function(e,t){return Array.isArray(t)?t.reduce(((t,n)=>(t[n]=function(...t){return e(this.$pinia)[n](...t)},t)),{}):Object.keys(t).reduce(((n,r)=>(n[r]=function(...n){return e(this.$pinia)[t[r]](...n)},n)),{})},mapGetters:S,mapState:E,mapStores:function(...e){return e.reduce(((e,t)=>(e[t.$id+D]=function(){return t(this.$pinia)},e)),{})},mapWritableState:function(e,t){return Array.isArray(t)?t.reduce(((t,n)=>(t[n]={get(){return e(this.$pinia)[n]},set(t){return e(this.$pinia)[n]=t}},t)),{}):Object.keys(t).reduce(((n,r)=>(n[r]={get(){return e(this.$pinia)[t[r]]},set(n){return e(this.$pinia)[t[r]]=n}},n)),{})},setActivePinia:o,setMapStoreSuffix:function(e){D=e},skipHydrate:function(e){return Object.defineProperty(e,w,{})},storeToRefs:function(t){{t=e.toRaw(t);const n={};for(const r in t){const i=t[r];(e.isRef(i)||e.isReactive(i))&&(n[r]=e.toRef(t,r))}return n}}},Symbol.toStringTag,{value:"Module"}));function I(e){let t;if("string"==typeof e)t=e.match(/[\da-f]{2}/gi);else{if(!Array.isArray(e))throw new Error("Invalid input. Input must be a string or an array.");t=e}return new Uint8Array(t.map((e=>parseInt(e,16)))).buffer}const _=x("bluetooth",{state:()=>({connected:!1,device:null,serviceUUID:"0000FFF0-0000-1000-8000-00805F9B34FB",receiveUUID:"0000FFF1-0000-1000-8000-00805F9B34FB",sendUUID:"0000FFF2-0000-1000-8000-00805F9B34FB"}),actions:{async startBleDevicesDiscovery(e){const n=this;return await uni.openBluetoothAdapter(),await uni.startBluetoothDevicesDiscovery({allowDuplicatesKey:!1,success(e){t("log","at stores/bluetooth.js:27","startBluetoothDevicesDiscovery====>",e)}}),uni.onBluetoothDeviceFound((t=>{e(t)})),()=>{n.stopBleDevicesDiscovery()}},async stopBleDevicesDiscovery(){await uni.stopBluetoothDevicesDiscovery(),await uni.closeBluetoothAdapter()},connect(e){const n=e.deviceId,r=this;return new Promise((async(i,s)=>{uni.createBLEConnection({deviceId:n,success(s){r.connected=!0,r.device=e,t("log","at stores/bluetooth.js:54","createBLEConnection",s),uni.onBLEConnectionStateChange((e=>{t("log","at stores/bluetooth.js:57",`device ${e.deviceId} state has changed, connected: ${e.connected}`)})),t("log","at stores/bluetooth.js:59","开始获取蓝牙服务",n,r.serviceUUID),setTimeout((()=>{uni.getBLEDeviceServices({deviceId:n,success(e){t("log","at stores/bluetooth.js:65","getBLEDeviceServices----》",e)},fail(e){t("log","at stores/bluetooth.js:68","getBLEDeviceServices----\x3eerr:",e)}})}),1500),setTimeout((()=>{uni.getBLEDeviceCharacteristics({deviceId:n,serviceId:r.serviceUUID,success(e){t("log","at stores/bluetooth.js:79","device getBLEDeviceCharacteristics:",e.characteristics)},fail(e){t("log","at stores/bluetooth.js:82","getBLEDeviceCharacteristics===》err",e)}}),i(s)}),2e3)},fail(e){s(e)},complete(){uni.stopBluetoothDevicesDiscovery()}})}))},notifyBLECharacteristicValueChange(e){const{device:n,serviceUUID:r,receiveUUID:i}=this;uni.notifyBLECharacteristicValueChange({state:!0,deviceId:n.deviceId,serviceId:r,characteristicId:i,success(e){t("log","at stores/bluetooth.js:108","notifyBLECharacteristicValueChange success",e.errMsg)}}),uni.onBLECharacteristicValueChange((function(n){var r;t("log","at stores/bluetooth.js:113",`characteristic ${n.characteristicId} has changed, now is ${n.value}`),e((r=n.value,Array.prototype.map.call(new Uint8Array(r),(function(e){return("00"+e.toString(16)).slice(-2)})).join(",").split(",")))}))},disconnect(e){const t=this;return new Promise(((n,r)=>{e?uni.closeBLEConnection({deviceId:e,success:function(e){t.deviceId=null,t.connected=!1,n(e)},fail:function(e){exception.dispose(e),r(e)}}):r("设备mac地址为空！")}))},write(e){const{device:n,serviceUUID:r,sendUUID:i}=this;return t("log","at stores/bluetooth.js:152","write====>",n.deviceId,e,r,i),new Promise(((s,a)=>{uni.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:r,characteristicId:i,value:e,success:e=>{t("log","at stores/bluetooth.js:160","writeBLECharacteristicValue success",e.errMsg),s(e)},fail:e=>{t("log","at stores/bluetooth.js:164","writeBLECharacteristicValue fail",e),a(e)}})}))},read(){const e=this.device.deviceId;return new Promise(((t,n)=>{uni.readBLECharacteristicValue({deviceId:e,serviceId:this.serviceUUID,characteristicId:this.sendUUID,success:e=>{t(e)},fail:e=>{n(e)}})}))}}}),V={__name:"index",setup(n){const s=_(),a=e.ref(!1),o=e.ref([]);function c(){o.value=[],s.startBleDevicesDiscovery((e=>{if(e.devices){const t=e.devices.filter((e=>e.name&&(e.name.includes("PD")||e.name.includes("BT")))),n=o.value;t.forEach((e=>{const t=n.findIndex((t=>t.deviceId===e.deviceId));t>-1?n[t]=e:n.push(e)})),o.value=n}}))}async function l(){a.value||(await s.stopBleDevicesDiscovery(),c()),a.value=!0,setTimeout((()=>{a.value=!1}),2e3)}return i((()=>{c()})),r((()=>{l()})),(n,r)=>(e.openBlock(),e.createElementBlock("view",{class:"content"},[e.createElementVNode("view",{class:"head-title action flex justify-between align-center"},[e.createElementVNode("view",null,[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl"},"设备列表（"+e.toDisplayString(o.value.length)+"）",1)]),e.createElementVNode("view",{class:"padding-tb"},[e.createElementVNode("image",{src:"/static/refresh.png",style:{width:"55rpx",height:"55rpx"},class:e.normalizeClass({"rotate-animation":a.value}),onClick:r[0]||(r[0]=e=>l())},null,2)])]),e.createElementVNode("scroll-view",{class:"device-scroll-view","scroll-y":""},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.value,((n,r)=>(e.openBlock(),e.createElementBlock("view",{class:"card article flex justify-between",key:r},[e.createElementVNode("view",{class:"card-item"},[e.createElementVNode("image",{class:"icon",src:"/static/bluetooth.png",mode:""}),e.createElementVNode("view",{class:"device-info"},[e.createElementVNode("text",{class:"text-bold"},e.toDisplayString(n.name||n.localName||"N/A"),1),e.createElementVNode("text",null,e.toDisplayString(n.deviceId),1),e.createElementVNode("text",{class:"text-cut"},e.toDisplayString(n.RSSI)+" dBm",1)])]),e.createElementVNode("view",{class:"card-item"},[e.createElementVNode("button",{class:"cu-btn round bg-blue",onClick:e=>{return r=n,uni.showLoading({title:"连接中...",mask:!0}),void s.connect(r).then((e=>{uni.showToast({title:"连接成功",duration:2e3}),uni.navigateTo({url:"/pages/upgrade"})})).catch((e=>{t("log","at pages/index.vue:65","连接失败=====>",e),uni.showToast({title:"连接失败",icon:"error",duration:2e3})})).finally((()=>{uni.hideLoading()}));var r}},"连接",8,["onClick"])])])))),128)),0===o.value.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"flex align-center justify-center padding-top"},[e.createElementVNode("image",{src:"/static/SvgSpinners180Ring.svg",style:{width:"40rpx",height:"40rpx"}}),e.createElementVNode("text",{class:"margin-left-sm"},"正在搜索设备... ")])):e.createCommentVNode("",!0)])]))}},B={bindec(e){t("log","at utils/BHD.ts:10","bindec---\x3e",e)},decbin(e){t("log","at utils/BHD.ts:15","decbin---\x3e",e)},decoct(e){t("log","at utils/BHD.ts:20","decoct---\x3e",e)},hexdec:e=>parseInt(e,16),dechex:e=>("string"==typeof e&&(e=parseInt(e)),e.toString(16).padStart(2,"0")),hexToAscii:e=>e.map((e=>String.fromCharCode(parseInt(e,16)))).join("").replace(/\s/g,"").toUpperCase(),hexArrToString:e=>e.map((e=>e.toUpperCase())).join(" ")};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function N(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var C={exports:{}};C.exports=function(){var e=1e3,t=6e4,n=36e5,r="millisecond",i="second",s="minute",a="hour",o="day",c="week",l="month",u="quarter",d="year",f="date",h="Invalid Date",p=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,v=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,g={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(e){var t=["th","st","nd","rd"],n=e%100;return"["+e+(t[(n-20)%10]||t[n]||t[0])+"]"}},m=function(e,t,n){var r=String(e);return!r||r.length>=t?e:""+Array(t+1-r.length).join(n)+e},y={s:m,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),r=Math.floor(n/60),i=n%60;return(t<=0?"+":"-")+m(r,2,"0")+":"+m(i,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var r=12*(n.year()-t.year())+(n.month()-t.month()),i=t.clone().add(r,l),s=n-i<0,a=t.clone().add(r+(s?-1:1),l);return+(-(r+(n-i)/(s?i-a:a-i))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:l,y:d,w:c,d:o,D:f,h:a,m:s,s:i,ms:r,Q:u}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},w="en",b={};b[w]=g;var $="$isDayjsObject",x=function(e){return e instanceof A||!(!e||!e[$])},D=function e(t,n,r){var i;if(!t)return w;if("string"==typeof t){var s=t.toLowerCase();b[s]&&(i=s),n&&(b[s]=n,i=s);var a=t.split("-");if(!i&&a.length>1)return e(a[0])}else{var o=t.name;b[o]=t,i=o}return!r&&i&&(w=i),i||!r&&w},E=function(e,t){if(x(e))return e.clone();var n="object"==typeof t?t:{};return n.date=e,n.args=arguments,new A(n)},S=y;S.l=D,S.i=x,S.w=function(e,t){return E(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var A=function(){function g(e){this.$L=D(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[$]=!0}var m=g.prototype;return m.parse=function(e){this.$d=function(e){var t=e.date,n=e.utc;if(null===t)return new Date(NaN);if(S.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var r=t.match(p);if(r){var i=r[2]-1||0,s=(r[7]||"0").substring(0,3);return n?new Date(Date.UTC(r[1],i,r[3]||1,r[4]||0,r[5]||0,r[6]||0,s)):new Date(r[1],i,r[3]||1,r[4]||0,r[5]||0,r[6]||0,s)}}return new Date(t)}(e),this.init()},m.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},m.$utils=function(){return S},m.isValid=function(){return!(this.$d.toString()===h)},m.isSame=function(e,t){var n=E(e);return this.startOf(t)<=n&&n<=this.endOf(t)},m.isAfter=function(e,t){return E(e)<this.startOf(t)},m.isBefore=function(e,t){return this.endOf(t)<E(e)},m.$g=function(e,t,n){return S.u(e)?this[t]:this.set(n,e)},m.unix=function(){return Math.floor(this.valueOf()/1e3)},m.valueOf=function(){return this.$d.getTime()},m.startOf=function(e,t){var n=this,r=!!S.u(t)||t,u=S.p(e),h=function(e,t){var i=S.w(n.$u?Date.UTC(n.$y,t,e):new Date(n.$y,t,e),n);return r?i:i.endOf(o)},p=function(e,t){return S.w(n.toDate()[e].apply(n.toDate("s"),(r?[0,0,0,0]:[23,59,59,999]).slice(t)),n)},v=this.$W,g=this.$M,m=this.$D,y="set"+(this.$u?"UTC":"");switch(u){case d:return r?h(1,0):h(31,11);case l:return r?h(1,g):h(0,g+1);case c:var w=this.$locale().weekStart||0,b=(v<w?v+7:v)-w;return h(r?m-b:m+(6-b),g);case o:case f:return p(y+"Hours",0);case a:return p(y+"Minutes",1);case s:return p(y+"Seconds",2);case i:return p(y+"Milliseconds",3);default:return this.clone()}},m.endOf=function(e){return this.startOf(e,!1)},m.$set=function(e,t){var n,c=S.p(e),u="set"+(this.$u?"UTC":""),h=(n={},n[o]=u+"Date",n[f]=u+"Date",n[l]=u+"Month",n[d]=u+"FullYear",n[a]=u+"Hours",n[s]=u+"Minutes",n[i]=u+"Seconds",n[r]=u+"Milliseconds",n)[c],p=c===o?this.$D+(t-this.$W):t;if(c===l||c===d){var v=this.clone().set(f,1);v.$d[h](p),v.init(),this.$d=v.set(f,Math.min(this.$D,v.daysInMonth())).$d}else h&&this.$d[h](p);return this.init(),this},m.set=function(e,t){return this.clone().$set(e,t)},m.get=function(e){return this[S.p(e)]()},m.add=function(r,u){var f,h=this;r=Number(r);var p=S.p(u),v=function(e){var t=E(h);return S.w(t.date(t.date()+Math.round(e*r)),h)};if(p===l)return this.set(l,this.$M+r);if(p===d)return this.set(d,this.$y+r);if(p===o)return v(1);if(p===c)return v(7);var g=(f={},f[s]=t,f[a]=n,f[i]=e,f)[p]||1,m=this.$d.getTime()+r*g;return S.w(m,this)},m.subtract=function(e,t){return this.add(-1*e,t)},m.format=function(e){var t=this,n=this.$locale();if(!this.isValid())return n.invalidDate||h;var r=e||"YYYY-MM-DDTHH:mm:ssZ",i=S.z(this),s=this.$H,a=this.$m,o=this.$M,c=n.weekdays,l=n.months,u=n.meridiem,d=function(e,n,i,s){return e&&(e[n]||e(t,r))||i[n].slice(0,s)},f=function(e){return S.s(s%12||12,e,"0")},p=u||function(e,t,n){var r=e<12?"AM":"PM";return n?r.toLowerCase():r};return r.replace(v,(function(e,r){return r||function(e){switch(e){case"YY":return String(t.$y).slice(-2);case"YYYY":return S.s(t.$y,4,"0");case"M":return o+1;case"MM":return S.s(o+1,2,"0");case"MMM":return d(n.monthsShort,o,l,3);case"MMMM":return d(l,o);case"D":return t.$D;case"DD":return S.s(t.$D,2,"0");case"d":return String(t.$W);case"dd":return d(n.weekdaysMin,t.$W,c,2);case"ddd":return d(n.weekdaysShort,t.$W,c,3);case"dddd":return c[t.$W];case"H":return String(s);case"HH":return S.s(s,2,"0");case"h":return f(1);case"hh":return f(2);case"a":return p(s,a,!0);case"A":return p(s,a,!1);case"m":return String(a);case"mm":return S.s(a,2,"0");case"s":return String(t.$s);case"ss":return S.s(t.$s,2,"0");case"SSS":return S.s(t.$ms,3,"0");case"Z":return i}return null}(e)||i.replace(":","")}))},m.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},m.diff=function(r,f,h){var p,v=this,g=S.p(f),m=E(r),y=(m.utcOffset()-this.utcOffset())*t,w=this-m,b=function(){return S.m(v,m)};switch(g){case d:p=b()/12;break;case l:p=b();break;case u:p=b()/3;break;case c:p=(w-y)/6048e5;break;case o:p=(w-y)/864e5;break;case a:p=w/n;break;case s:p=w/t;break;case i:p=w/e;break;default:p=w}return h?p:S.a(p)},m.daysInMonth=function(){return this.endOf(l).$D},m.$locale=function(){return b[this.$L]},m.locale=function(e,t){if(!e)return this.$L;var n=this.clone(),r=D(e,t,!0);return r&&(n.$L=r),n},m.clone=function(){return S.w(this.$d,this)},m.toDate=function(){return new Date(this.valueOf())},m.toJSON=function(){return this.isValid()?this.toISOString():null},m.toISOString=function(){return this.$d.toISOString()},m.toString=function(){return this.$d.toUTCString()},g}(),I=A.prototype;return E.prototype=I,[["$ms",r],["$s",i],["$m",s],["$H",a],["$W",o],["$M",l],["$y",d],["$D",f]].forEach((function(e){I[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),E.extend=function(e,t){return e.$i||(e(t,A,E),e.$i=!0),E},E.locale=D,E.isDayjs=x,E.unix=function(e){return E(1e3*e)},E.en=b[w],E.Ls=b,E.p={},E}();const M=N(C.exports),O=((e,t)=>{const n=e.__vccOpts||e;for(const[r,i]of t)n[r]=i;return n})({__name:"logs",props:{logs:String},setup(t){const n=t,r=e.getCurrentInstance(),i=e.ref(0),s=e.ref(0),{logs:a}=e.toRefs(n);return e.onMounted((()=>{uni.createSelectorQuery().in(r).select(".log-scroll-view").boundingClientRect((e=>{e&&(s.value=e.height)})).exec()})),e.watch(a,(()=>{uni.createSelectorQuery().in(r).select(".scroll-content").boundingClientRect((e=>{if(e){const t=e.height-s.value;t>0&&(i.value=t)}})).exec()})),(t,n)=>(e.openBlock(),e.createElementBlock("scroll-view",{class:"log-scroll-view bg-white","scroll-y":"","scroll-top":i.value,"scroll-with-animation":!0},[e.createElementVNode("view",{class:"scroll-content"},[e.createElementVNode("text",null,e.toDisplayString(e.unref(a)),1)])],8,["scroll-top"]))}},[["__scopeId","data-v-2b5823cb"]]),U={__name:"upgrade",setup(n){const r=_(),{device:a}=r,o=e.ref(""),c=e.ref(""),l=e.ref(0),u=e.ref(0),d=e.ref(!1),f=e.ref(null),h=e.ref(null);let p=null;const v=e.computed((()=>{const e=u.value/l.value*100||0;return 0!==e?`${parseInt(e)}%`:""}));let g;i((()=>{x(),uni.downloadFile({url:"https://yuexing.zebblog.com/downloads/OTA_File.bin",success:e=>{200===e.statusCode&&m(e.tempFilePath).then((e=>{h.value=new Uint8Array(e)}))}})})),e.onMounted((()=>{E()}));const m=e=>new Promise(((t,n)=>{try{plus.io.resolveLocalFileSystemURL(e,(function(e){e.file((function(e){const n=new plus.io.FileReader;n.readAsDataURL(e),f.value=e,n.onloadend=function(n){const r={base64:n.target.result.split(",")[1],size:e.size};t(uni.base64ToArrayBuffer(r.base64))}}))}),(function(e){n(e)}))}catch(r){n(r)}}));function y(){if(h.value){S("=====> 开始准备Bluetooth OTA <=====");const e=function(e,t){let n=[];for(let r=0;r<e.length;r+=t)n.push(new Uint8Array(e.slice(r,r+t)));return n=n.map(((e,t)=>{const n=e.length,r=e.reduce(((e,t)=>e+t),0),i=new Uint8Array(n+3);return i[0]=90,i[1]=n,i.set(e,2),i[n+2]=r,i})),n}(h.value,64);l.value=e.length,u.value=0,S(`已处理完成OTA文件共计：${e.length}个分包。`),setTimeout((()=>{r.write(I(["A5","01","EF"]))}),300),p=function*(e){for(let t=0;t<e.length;t++)yield{item:e[t],index:t+1}}(e),d.value=!0,g=setTimeout((()=>{S("=====> OTA超时 <====="),uni.showModal({title:"提示",content:"OTA超时!!!",showCancel:!1}),d.value=!1,p=null}),3e5)}else S("=====> Error OTA 失败找不到源文件 <=====")}const w=["A5","10","0C","00","EF"],b=["5A","00","00"],$=["A5","FF","EF"],x=()=>{let e=!1;const n=()=>{var t;const n=p.next();n.done?(e=!0,r.write(I(b)),S("结束数据帧的发送")):(u.value=null==(t=n.value)?void 0:t.index,r.write(n.value.item.buffer),S(`发送第${n.value.index}包数据`))};r.notifyBLECharacteristicValueChange((i=>{if(t("log","at pages/upgrade.vue:227","notifyBLECharacteristicValueChange====>",i,B.hexToAscii(i)),"55"===i[0]&&"aa"===i[1]&&"ee"===i[2]&&i.length>8){const e=B.hexArrToString(i);S(`收到设备应答：${e}`),o.value=e}const s=B.hexToAscii(i);p&&(S(`收到设备应答：${s}`),D(s,"A501FE")&&(S("开始数据帧的发送"),r.write(I(w))),D(s,"A511FE")&&n(),D(s,"A502FE")&&(e?(S("退出BootLoader"),r.write(I($))):n()),D(s,"A5FFFE")&&(clearTimeout(g),uni.showModal({title:"提示",content:"固件升级成功",showCancel:!1}),S("=====> 结束Bluetooth OTA <====="),d.value=!1,p=null,E()),D(s,"A544FE")&&(r.write(I(b)),S("=====> OTA失败 <====="),clearTimeout(g),uni.showModal({title:"提示",content:"OTA失败!!!",showCancel:!1})))}))},D=(e,t)=>String(e).toUpperCase()===String(t).toUpperCase(),E=()=>{S("=====> 获取设备版本号 <====="),setTimeout((()=>{r.write(I(["55","AA","DE","00","00","00","00","21","0D","0A"]))}),1e3)};const S=e=>{c.value+=`${M().format("HH:mm:ss")}：${e}\n`};return s((()=>{f.value&&uni.removeSavedFile({filePath:f.value.fullPath}),r.disconnect(null==a?void 0:a.deviceId)})),(t,n)=>{var r,i,s,l,u;return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("scroll-view",{class:"container","scroll-y":"false"},[e.createElementVNode("view",null,[e.createElementVNode("view",{class:"device-container"},[e.createElementVNode("view",{class:"title padding-sm"},[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl"},"设备信息")]),e.createElementVNode("view",{class:"flex align-center padding-sm"},[e.createElementVNode("image",{src:"/static/bluetooth.png",class:"icon"}),e.createElementVNode("view",{class:"flex flex-direction margin-left"},[e.createElementVNode("text",{class:"text-bold"},"设备名："+e.toDisplayString((null==(r=e.unref(a))?void 0:r.name)||(null==(i=e.unref(a))?void 0:i.localName)||"N/A"),1),e.createElementVNode("text",{class:"text-bold"},"设备ID："+e.toDisplayString((null==(s=e.unref(a))?void 0:s.deviceId)||"N/A"),1),e.createElementVNode("text",{class:"text-bold"},"当前版本号："+e.toDisplayString(o.value||"--"),1)])])]),e.createElementVNode("view",null,[e.createElementVNode("view",{class:"title padding-sm"},[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl"},"BIN文件信息")]),e.createElementVNode("view",{class:"flex flex-direction padding-sm"},[e.createElementVNode("text",{class:"text-bold"},"文件名："+e.toDisplayString((null==(l=f.value)?void 0:l.name)||"--"),1),e.createElementVNode("text",{class:"text-bold"},"上传时间："+e.toDisplayString(e.unref(M)(null==(u=f.value)?void 0:u.lastModifiedDate).format("YYYY-MM-DD HH:mm:ss")||"--"),1)])]),e.createElementVNode("view",null,[e.createElementVNode("view",{class:"title padding-sm"},[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl"},"进度")]),e.createElementVNode("view",{class:"padding-sm"},[e.createElementVNode("view",{class:"cu-progress radius striped active round"},[e.createElementVNode("view",{class:"bg-blue",style:e.normalizeStyle([{width:v.value}])},e.toDisplayString(v.value),5)])])]),e.createElementVNode("view",{class:"log-container"},[e.createElementVNode("view",{class:"title padding-sm"},[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl",ref:"logsRef"},"日志",512)]),e.createElementVNode("view",{class:"padding bg-white"},[e.createVNode(e.unref(O),{logs:c.value},null,8,["logs"])])])])]),e.createElementVNode("view",{class:"foot-container padding"},[e.createElementVNode("button",{class:"cu-btn round bg-blue lg margin-bottom-xs",onClick:n[0]||(n[0]=e=>E()),disabled:d.value},"获取版本号",8,["disabled"]),e.createElementVNode("button",{class:"cu-btn round bg-blue lg",onClick:n[1]||(n[1]=e=>y()),disabled:d.value},"开始OTA",8,["disabled"])])],64)}}};__definePage("pages/index",V),__definePage("pages/upgrade",U);const j={onLaunch:function(){t("log","at App.vue:4","App Launch")},onShow:function(){t("log","at App.vue:7","App Show")},onHide:function(){t("log","at App.vue:10","App Hide")}};const{app:T,Vuex:F,Pinia:k}=function(){const t=e.createVueApp(j);return t.use(h()),{app:t,Pinia:A}}();uni.Vuex=F,uni.Pinia=k,T.provide("__globalStyles",__uniConfig.styles),T._component.mpType="app",T._component.render=()=>{},T.mount("#app")}(Vue);
