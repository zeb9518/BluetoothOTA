if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((n=>t.resolve(e()).then((()=>n))),(n=>t.resolve(e()).then((()=>{throw n}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...n){uni.__log__?uni.__log__(e,t,...n):console[e].apply(console,[...n,t])}const n=(t=>(n,i=e.getCurrentInstance())=>{!e.isInSSRComponentSetup&&e.injectHook(t,n,i)})("onReady");
/*!
   * pinia v2.1.7
   * (c) 2023 Eduardo San Martin Morote
   * @license MIT
   */
let i;const o=e=>i=e,c=Symbol();function s(e){return e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)&&"function"!=typeof e.toJSON}var r,a;(a=r||(r={})).direct="direct",a.patchObject="patch object",a.patchFunction="patch function";const l="undefined"!=typeof window;function u(){const t=e.effectScope(!0),n=t.run((()=>e.ref({})));let i=[],s=[];const r=e.markRaw({install(e){o(r),r._a=e,e.provide(c,r),e.config.globalProperties.$pinia=r,s.forEach((e=>i.push(e))),s=[]},use(e){return this._a?i.push(e):s.push(e),this},_p:i,_a:null,_e:t,_s:new Map,state:n});return r}const d=()=>{};function p(t,n,i,o=d){t.push(n);const c=()=>{const e=t.indexOf(n);e>-1&&(t.splice(e,1),o())};return!i&&e.getCurrentScope()&&e.onScopeDispose(c),c}function f(e,...t){e.slice().forEach((e=>{e(...t)}))}const h=e=>e();function v(t,n){t instanceof Map&&n instanceof Map&&n.forEach(((e,n)=>t.set(n,e))),t instanceof Set&&n instanceof Set&&n.forEach(t.add,t);for(const i in n){if(!n.hasOwnProperty(i))continue;const o=n[i],c=t[i];s(c)&&s(o)&&t.hasOwnProperty(i)&&!e.isRef(o)&&!e.isReactive(o)?t[i]=v(c,o):t[i]=o}return t}const y=Symbol();const{assign:g}=Object;function m(t,n,i={},c,a,l){let u;const m=g({actions:{}},i),E={deep:!0};let b,w,A,I=[],x=[];const V=c.state.value[t];let B;function _(n){let i;b=w=!1,"function"==typeof n?(n(c.state.value[t]),i={type:r.patchFunction,storeId:t,events:A}):(v(c.state.value[t],n),i={type:r.patchObject,payload:n,storeId:t,events:A});const o=B=Symbol();e.nextTick().then((()=>{B===o&&(b=!0)})),w=!0,f(I,i,c.state.value[t])}l||V||(c.state.value[t]={}),e.ref({});const S=l?function(){const{state:e}=i,t=e?e():{};this.$patch((e=>{g(e,t)}))}:d;function C(e,n){return function(){o(c);const i=Array.from(arguments),s=[],r=[];function a(e){s.push(e)}function l(e){r.push(e)}let u;f(x,{args:i,name:e,store:j,after:a,onError:l});try{u=n.apply(this&&this.$id===t?this:j,i)}catch(d){throw f(r,d),d}return u instanceof Promise?u.then((e=>(f(s,e),e))).catch((e=>(f(r,e),Promise.reject(e)))):(f(s,u),u)}}const N={_p:c,$id:t,$onAction:p.bind(null,x),$patch:_,$reset:S,$subscribe(n,i={}){const o=p(I,n,i.detached,(()=>s())),s=u.run((()=>e.watch((()=>c.state.value[t]),(e=>{("sync"===i.flush?w:b)&&n({storeId:t,type:r.direct,events:A},e)}),g({},E,i))));return o},$dispose:function(){u.stop(),I=[],x=[],c._s.delete(t)}},j=e.reactive(N);c._s.set(t,j);const D=(c._a&&c._a.runWithContext||h)((()=>c._e.run((()=>(u=e.effectScope()).run(n)))));for(const o in D){const n=D[o];if(e.isRef(n)&&(F=n,!e.isRef(F)||!F.effect)||e.isReactive(n))l||(!V||s(U=n)&&U.hasOwnProperty(y)||(e.isRef(n)?n.value=V[o]:v(n,V[o])),c.state.value[t][o]=n);else if("function"==typeof n){const e=C(o,n);D[o]=e,m.actions[o]=n}}var U,F;return g(j,D),g(e.toRaw(j),D),Object.defineProperty(j,"$state",{get:()=>c.state.value[t],set:e=>{_((t=>{g(t,e)}))}}),c._p.forEach((e=>{g(j,u.run((()=>e({store:j,app:c._a,pinia:c,options:m}))))})),V&&l&&i.hydrate&&i.hydrate(j.$state,V),b=!0,w=!0,j}function E(t,n,s){let r,a;const l="function"==typeof n;function u(t,s){const u=e.hasInjectionContext();(t=t||(u?e.inject(c,null):null))&&o(t),(t=i)._s.has(r)||(l?m(r,n,a,t):function(t,n,i,c){const{state:s,actions:r,getters:a}=n,l=i.state.value[t];let u;u=m(t,(function(){l||(i.state.value[t]=s?s():{});const n=e.toRefs(i.state.value[t]);return g(n,r,Object.keys(a||{}).reduce(((n,c)=>(n[c]=e.markRaw(e.computed((()=>{o(i);const e=i._s.get(t);return a[c].call(e,e)}))),n)),{}))}),n,i,0,!0)}(r,a,t));return t._s.get(r)}return"string"==typeof t?(r=t,a=l?s:n):(a=t,r=t.id),u.$id=r,u}let b="Store";function w(e,t){return Array.isArray(t)?t.reduce(((t,n)=>(t[n]=function(){return e(this.$pinia)[n]},t)),{}):Object.keys(t).reduce(((n,i)=>(n[i]=function(){const n=e(this.$pinia),o=t[i];return"function"==typeof o?o.call(this,n):n[o]},n)),{})}const A=w;const I=Object.freeze(Object.defineProperty({__proto__:null,get MutationType(){return r},PiniaVuePlugin:function(e){e.mixin({beforeCreate(){const e=this.$options;if(e.pinia){const t=e.pinia;if(!this._provided){const e={};Object.defineProperty(this,"_provided",{get:()=>e,set:t=>Object.assign(e,t)})}this._provided[c]=t,this.$pinia||(this.$pinia=t),t._a=this,l&&o(t)}else!this.$pinia&&e.parent&&e.parent.$pinia&&(this.$pinia=e.parent.$pinia)},destroyed(){delete this._pStores}})},acceptHMRUpdate:function(e,t){return()=>{}},createPinia:u,defineStore:E,getActivePinia:()=>e.hasInjectionContext()&&e.inject(c)||i,mapActions:function(e,t){return Array.isArray(t)?t.reduce(((t,n)=>(t[n]=function(...t){return e(this.$pinia)[n](...t)},t)),{}):Object.keys(t).reduce(((n,i)=>(n[i]=function(...n){return e(this.$pinia)[t[i]](...n)},n)),{})},mapGetters:A,mapState:w,mapStores:function(...e){return e.reduce(((e,t)=>(e[t.$id+b]=function(){return t(this.$pinia)},e)),{})},mapWritableState:function(e,t){return Array.isArray(t)?t.reduce(((t,n)=>(t[n]={get(){return e(this.$pinia)[n]},set(t){return e(this.$pinia)[n]=t}},t)),{}):Object.keys(t).reduce(((n,i)=>(n[i]={get(){return e(this.$pinia)[t[i]]},set(n){return e(this.$pinia)[t[i]]=n}},n)),{})},setActivePinia:o,setMapStoreSuffix:function(e){b=e},skipHydrate:function(e){return Object.defineProperty(e,y,{})},storeToRefs:function(t){{t=e.toRaw(t);const n={};for(const i in t){const o=t[i];(e.isRef(o)||e.isReactive(o))&&(n[i]=e.toRef(t,i))}return n}}},Symbol.toStringTag,{value:"Module"}));function x(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map((function(e){return parseInt(e,16)}))).buffer}const V=E("bluetooth",{state:()=>({connected:!1,device:null,serviceUUID:"0000FFE0-0000-1000-8000-00805F9B34FB",sendUUID:"0000FFE2-0000-1000-8000-00805F9B34FB",receiveUUID:"0000FFE1-0000-1000-8000-00805F9B34FB"}),actions:{startBleDevicesDiscovery:async e=>(await uni.openBluetoothAdapter(),await uni.startBluetoothDevicesDiscovery({allowDuplicatesKey:!1,success(e){t("log","at stores/bluetooth.js:26","startBluetoothDevicesDiscovery====>",e)}}),uni.onBluetoothDeviceFound((t=>{e(t)})),()=>{uni.stopBluetoothDevicesDiscovery(),uni.closeBluetoothAdapter()}),connect(e){const n=e.deviceId,i=this;return new Promise((async(o,c)=>{uni.createBLEConnection({deviceId:n,success(c){i.connected=!0,i.device=e,t("log","at stores/bluetooth.js:49","createBLEConnection",c),uni.onBLEConnectionStateChange((e=>{t("log","at stores/bluetooth.js:52",`device ${e.deviceId} state has changed, connected: ${e.connected}`)})),setTimeout((()=>{uni.getBLEDeviceServices({deviceId:n,success(e){t("log","at stores/bluetooth.js:59","device services:",e)}}),uni.getBLEDeviceCharacteristics({deviceId:n,serviceId:i.serviceId,success(e){t("log","at stores/bluetooth.js:67","device getBLEDeviceCharacteristics:",e.characteristics)},fail(e){t("log","at stores/bluetooth.js:70","getBLEDeviceCharacteristics===》err",e)}})}),3e3),o(c)},fail(e){c(e)},complete(){uni.stopBluetoothDevicesDiscovery()}})}))},getBLEDeviceServicesAndCharacteristics(e){},notifyBLECharacteristicValueChange(e){const{device:n,serviceUUID:i,receiveUUID:o}=this;uni.notifyBLECharacteristicValueChange({state:!0,deviceId:n.deviceId,serviceId:i,characteristicId:o,success(e){t("log","at stores/bluetooth.js:101","notifyBLECharacteristicValueChange success",e.errMsg)}}),uni.onBLECharacteristicValueChange((function(n){var i;t("log","at stores/bluetooth.js:106",`characteristic ${n.characteristicId} has changed, now is ${n.value}`),e((i=n.value,Array.prototype.map.call(new Uint8Array(i),(function(e){return("00"+e.toString(16)).slice(-2)})).join(",").split(",")))}))},disconnect(e){const t=this;return new Promise(((n,i)=>{e?uni.closeBLEConnection({deviceId:e,success:function(e){t.deviceId=null,t.connected=!1,n(e)},fail:function(e){exception.dispose(e),i(e)}}):i("设备mac地址为空！")}))},write(e){const{device:n,serviceUUID:i,sendUUID:o}=this;return t("log","at stores/bluetooth.js:145","write====>",n.deviceId,e,i,o),new Promise(((c,s)=>{uni.writeBLECharacteristicValue({deviceId:n.deviceId,serviceId:i,characteristicId:o,value:e,success:e=>{t("log","at stores/bluetooth.js:153","writeBLECharacteristicValue success",e.errMsg),c(e)},fail:e=>{t("log","at stores/bluetooth.js:157","writeBLECharacteristicValue fail",e),s(e)}})}))},read(){const e=this.device.deviceId;return new Promise(((t,n)=>{uni.readBLECharacteristicValue({deviceId:e,serviceId:this.serviceUUID,characteristicId:this.sendUUID,success:e=>{t(e)},fail:e=>{n(e)}})}))}}}),B={__name:"index",setup(i){const o=V(),c=e.ref([]);return n((()=>{o.startBleDevicesDiscovery((e=>{if(e.devices){const t=e.devices.filter((e=>e.name||e.localName)),n=c.value;t.forEach((e=>{const t=n.findIndex((t=>t.deviceId===e.deviceId));t>-1?n[t]=e:n.push(e)})),c.value=n}}))})),(n,i)=>(e.openBlock(),e.createElementBlock("view",{class:"content"},[e.createElementVNode("view",{class:"head-title action"},[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl"},"设备列表（"+e.toDisplayString(c.value.length)+"）",1)]),e.createElementVNode("scroll-view",{class:"device-scroll-view","scroll-y":""},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(c.value,((n,i)=>(e.openBlock(),e.createElementBlock("view",{class:"card article flex justify-between",key:i},[e.createElementVNode("view",{class:"card-item"},[e.createElementVNode("image",{class:"icon",src:"/static/bluetooth.png",mode:""}),e.createElementVNode("view",{class:"device-info"},[e.createElementVNode("text",{class:"text-bold"},e.toDisplayString(n.name||n.localName||"N/A"),1),e.createElementVNode("text",null,e.toDisplayString(n.deviceId),1),e.createElementVNode("text",{class:"text-cut"},e.toDisplayString(n.RSSI)+" dBm",1)])]),e.createElementVNode("view",{class:"card-item"},[e.createElementVNode("button",{class:"cu-btn round bg-blue",onClick:e=>{return i=n,uni.showLoading({title:"连接中...",mask:!0}),void o.connect(i).then((e=>{uni.showToast({title:"连接成功",duration:2e3}),uni.navigateTo({url:"/pages/upgrade"})})).catch((e=>{t("log","at pages/index.vue:61","连接失败=====>",e),uni.showToast({title:"连接失败",icon:"error",duration:2e3})})).finally((()=>{uni.hideLoading()}));var i}},"连接",8,["onClick"])])])))),128))])]))}};__definePage("pages/upgrade",{__name:"upgrade",setup(n){const i=V();e.ref([]);const o=e=>new Promise(((t,n)=>{try{plus.io.resolveLocalFileSystemURL(e,(function(e){e.file((function(e){const n=new plus.io.FileReader;n.readAsDataURL(e),n.onloadend=function(n){const i={base64:n.target.result.split(",")[1],size:e.size};t(uni.base64ToArrayBuffer(i.base64))}}))}),(function(e){n(e)}))}catch(i){n(i)}}));function c(e){let t="";for(let n=0;n<e.length;n++)t+=e.charCodeAt(n).toString(16).padStart(2,"0")+" ";return t.trim().toUpperCase()}async function s(){const e=await new Promise(((e,t)=>{uni.downloadFile({url:"https://yuexing.zebblog.com/downloads/hex/LowPowerTK_Demo.hex",success:t=>{200===t.statusCode&&o(t.tempFilePath).then((t=>{e(t)}))}})})),n=function(e,t){let n=[];for(let i=0;i<e.length;i+=t)n.push(new Uint8Array(e.slice(i,i+t)));return n}(new Uint8Array(e),128);let s=!1;i.write(x(c("A5 01 EF")));const r=function*(e){for(let t=0;t<e.length;t++)yield e[t]}(n);let a=r.next();i.notifyBLECharacteristicValueChange((e=>{if(t("log","at pages/upgrade.vue:135","notifyBLECharacteristicValueChange====>",e),"A5 01 EF"===e)i.write(x(c("A5 10 05 00 EF")));else if("A5 11 EF"===e)i.write(a.value.buffer);else if("A5 02 EF"===e){if(a.done&&s&&i.write(x(c("A5 FF EF"))),a.done&&!s)return s=!0,void i.write(x(c("5A 00 00")));a=r.next(),i.write(a.value.buffer)}}))}return(t,n)=>(e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"device-container"},[e.createElementVNode("view",{class:"title action"},[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl"},"设备信息")]),e.createElementVNode("view",{class:"flex align-center padding"},[e.createElementVNode("image",{src:"/static/bluetooth.png",class:"icon"}),e.createElementVNode("view",{class:"flex flex-direction margin-left"},[e.createElementVNode("text",{class:"text-bold"},"设备名："),e.createElementVNode("text",{class:"text-bold"},"设备ID："),e.createElementVNode("text",{class:"text-bold"},"当前版本号：")])])]),e.createElementVNode("view",null,[e.createElementVNode("view",{class:"title action"},[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl"},"进度")]),e.createElementVNode("view",{class:"padding"},[e.createElementVNode("view",{class:"cu-progress radius striped active round"},[e.createElementVNode("view",{class:"bg-blue",style:e.normalizeStyle([{width:"30%"}])},"30%")])])]),e.createElementVNode("view",{class:"log-container"},[e.createElementVNode("view",{class:"title action"},[e.createElementVNode("text",{class:"cuIcon-titles text-blue"}),e.createElementVNode("text",{class:"text-xl"},"日志")]),e.createElementVNode("scroll-view",{class:"log-box bg-white padding","scroll-y":""},[(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(100,(t=>e.createElementVNode("view",null,e.toDisplayString(t),1))),64))])]),e.createElementVNode("view",{class:"foot-container padding"},[e.createElementVNode("button",{class:"cu-btn round bg-blue lg",onClick:n[0]||(n[0]=e=>s())},"开始OTA")])]))}}),__definePage("pages/index",B);const _={onLaunch:function(){t("log","at App.vue:4","App Launch")},onShow:function(){t("log","at App.vue:7","App Show")},onHide:function(){t("log","at App.vue:10","App Hide")}};const{app:S,Vuex:C,Pinia:N}=function(){const t=e.createVueApp(_);return t.use(u()),{app:t,Pinia:I}}();uni.Vuex=C,uni.Pinia=N,S.provide("__globalStyles",__uniConfig.styles),S._component.mpType="app",S._component.render=()=>{},S.mount("#app")}(Vue);
